<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººå£ç»æµåˆ†æä¸ç©ºé—´åˆ†æç®¡ç†åå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .header-bg {
            background-color: #0d6efd;
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        .content-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-group-nav .btn {
            font-size: 1.1rem;
        }
        .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #0d6efd;
        }
        /* é¢„æµ‹è¾“å…¥è¡¨æ ¼æ ·å¼ */
        .predict-input-table input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: right;
        }
        .predict-input-table input:focus {
            outline: 2px solid #86b7fe;
            background: #fff;
        }
    </style>
</head>
<body>

    <header class="header-bg">
        <div class="container">
            <h1 class="text-center">äººå£ç»æµåˆ†æä¸ç©ºé—´åˆ†æåç«¯ç®¡ç†ç•Œé¢</h1>
            <p class="text-center lead">APIæœåŠ¡çŠ¶æ€: **http://localhost:5000**</p>
            <div class="text-center mt-3">
                <a href="/api-test" class="btn btn-light btn-sm" target="_blank">
                    ğŸš€ APIæ¥å£æµ‹è¯•é¡µé¢
                </a>
            </div>
        </div>
    </header>

    <div class="container">

        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">ğŸ“Š æ¦‚è§ˆ & åŸºç¡€æ•°æ®</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="coupling-tab" data-bs-toggle="tab" data-bs-target="#coupling" type="button" role="tab">ğŸ”— è€¦åˆåè°ƒåº¦åˆ†æ</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="spatial-tab" data-bs-toggle="tab" data-bs-target="#spatial" type="button" role="tab">ğŸ—ºï¸ GDPç©ºé—´åˆ†æ</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="predict-tab" data-bs-toggle="tab" data-bs-target="#predict" type="button" role="tab">ğŸ”® GDP é¢„æµ‹æ¨¡å‹</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">

            <!-- 1. æ¦‚è§ˆ & åŸºç¡€æ•°æ® -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel" tabindex="0">
                <div class="card content-card">
                    <div class="card-header bg-primary text-white">
                        <h5>æ•°æ®åº“è¡¨ä¿¡æ¯ (<span id="tableCount">0</span>ä¸ª)</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>è¡¨å</th>
                                    <th>åŸºç¡€APIè·¯å¾„</th>
                                    <th>å•ä½</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tableListBody">
                                <tr><td colspan="4" class="text-center">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="dataModalLabel"></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>å•ä½: <strong id="dataModalUnit"></strong></p>
                                <p>æ€»è®°å½•æ•°: <strong id="dataModalTotal"></strong></p>
                                <div class="data-table-container">
                                    <table class="table table-bordered table-sm" id="dataDetailTable">
                                        </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. è€¦åˆåè°ƒåº¦åˆ†æ -->
            <div class="tab-pane fade" id="coupling" role="tabpanel" tabindex="0">
                <div class="card content-card">
                    <div class="card-header bg-success text-white">
                        <h5>è€¦åˆåè°ƒåº¦åˆ†æç»“æœæŸ¥è¯¢</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-auto">
                                <label for="couplingYearSelect" class="col-form-label">é€‰æ‹©å¹´ä»½:</label>
                            </div>
                            <div class="col-auto">
                                <select class="form-select" id="couplingYearSelect">
                                    </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-success" id="loadCouplingDataBtn">åŠ è½½åˆ†ææ•°æ®</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-info" id="loadCouplingTrendBtn">åŠ è½½å…¨éƒ¨å¹´ä»½è¶‹åŠ¿æ•°æ®</button>
                            </div>
                        </div>

                        <div id="couplingResultArea">
                            <h6 class="mt-4">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ (<span id="couplingStatsYear"></span>å¹´)</h6>
                            <pre id="couplingStats" class="bg-light p-3 rounded"></pre>

                            <h6 class="mt-4">ğŸ“œ åœ°åŒºæ’ååˆ—è¡¨</h6>
                            <div class="data-table-container">
                                <table class="table table-bordered table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>æ’å</th>
                                            <th>åœ°åŒº</th>
                                            <th>åè°ƒåº¦ (D)</th>
                                            <th>åè°ƒç­‰çº§</th>
                                            <th>å‘å±•ç±»å‹</th>
                                            <th>è€¦åˆåº¦ (C)</th>
                                            <th>ç»¼åˆæŒ‡æ•° (T)</th>
                                            <th>äººå£æŒ‡æ•° (U_p)</th>
                                            <th>GDPæŒ‡æ•° (U_e)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="couplingRegionsBody">
                                        <tr><td colspan="9" class="text-center">è¯·é€‰æ‹©å¹´ä»½å¹¶ç‚¹å‡»åŠ è½½</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <h6 class="mt-4">ğŸ“ˆ è¶‹åŠ¿æ•°æ®</h6>
                            <div class="data-table-container" style="max-height: 200px;">
                                <pre id="couplingTrendData" class="bg-light p-3 rounded small"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. GDPç©ºé—´åˆ†æ -->
            <div class="tab-pane fade" id="spatial" role="tabpanel" tabindex="0">
                <div class="card content-card">
                    <div class="card-header bg-danger text-white">
                        <h5>GDPç©ºé—´åˆ†æ (Moran's I, LISA, Gi*)</h5>
                    </div>
                    <div class="card-body">
                        <p class="alert alert-warning">
                            **æ³¨æ„:** ç©ºé—´åˆ†ææ•°æ®éœ€è¦æ‰‹åŠ¨è§¦å‘ç”Ÿæˆã€‚K=4è¿‘é‚»ï¼Œæ’åˆ—æ£€éªŒæ¬¡æ•° perm=99ã€‚
                        </p>

                        <div class="d-flex mb-3">
                            <button class="btn btn-danger me-3" id="refreshSpatialDataBtn">ğŸš€ åˆ·æ–°/ç”Ÿæˆç©ºé—´åˆ†ææ•°æ® (POST /api/spatial/refresh)</button>
                            <button class="btn btn-outline-danger" id="loadSpatialYearsBtn">ğŸ”„ åŠ è½½å¯ç”¨å¹´ä»½</button>
                        </div>
                        
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-auto">
                                <label for="spatialYearSelect" class="col-form-label">é€‰æ‹©å·²åˆ†æå¹´ä»½:</label>
                            </div>
                            <div class="col-auto">
                                <select class="form-select" id="spatialYearSelect">
                                    </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary" id="loadSpatialStatsBtn">åŠ è½½ç»Ÿè®¡ä¿¡æ¯</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary" id="loadSpatialGeoJsonBtn">æŸ¥çœ‹ GeoJSON æ•°æ®</button>
                            </div>
                        </div>

                        <div id="spatialResultArea">
                            <h6 class="mt-4">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ (<span id="spatialStatsYear"></span>å¹´)</h6>
                            <pre id="spatialStats" class="bg-light p-3 rounded"></pre>

                            <h6 class="mt-4">ğŸ—ºï¸ GeoJSON æ•°æ®é¢„è§ˆ</h6>
                            <div class="data-table-container" style="max-height: 250px;">
                                <pre id="spatialGeoJson" class="bg-dark text-white p-3 rounded small"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. GDP é¢„æµ‹æ¨¡å‹ (New) -->
            <div class="tab-pane fade" id="predict" role="tabpanel" tabindex="0">
                <div class="card content-card">
                    <div class="card-header bg-purple text-white" style="background-color: #6f42c1;">
                        <h5>ğŸ”® GDP é¢„æµ‹æ¨¡å‹ (Seq2Seq LSTM)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label"><strong>é€‰æ‹©çœä»½</strong></label>
                                <select class="form-select form-select-lg" id="predictProvinceSelect">
                                    <!-- çœä»½åˆ—è¡¨å°†é€šè¿‡JSå¡«å…… -->
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary btn-lg w-100" id="fetchAndDisplayChartBtn" style="background-color: #6f42c1; border-color: #6f42c1;">
                                    ğŸ“Š è·å–æ•°æ®å¹¶ç”Ÿæˆå›¾è¡¨
                                </button>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-success btn-lg w-100" id="exportDatabaseBtn">
                                    ğŸ’¾ å¯¼å‡ºæ•°æ®åº“
                                </button>
                            </div>
                        </div>


                        <!-- é¢„æµ‹ç»“æœè¡¨æ ¼ -->
                        <div id="predictionResultArea" style="display: none;">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">ğŸ“ˆ GDPå†å²ä¸é¢„æµ‹æ•°æ®</h5>
                                </div>
                                <div class="card-body">
                                    <div class="data-table-container" style="max-height: 500px;">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>å¹´ä»½</th>
                                                    <th>GDP (äº¿)</th>
                                                    <th>æ•°æ®ç±»å‹</th>
                                                </tr>
                                            </thead>
                                            <tbody id="predictionResultBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è®­ç»ƒæŒ‡æ ‡å±•ç¤ºåŒºåŸŸ -->
                        <div id="metricsResultArea" style="display: none; margin-top: 20px;">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">ğŸ“Š æ¨¡å‹è®­ç»ƒæŒ‡æ ‡</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <h6>ğŸ“‹ è®­ç»ƒä¿¡æ¯</h6>
                                            <div id="trainingInfo">
                                                <!-- è®­ç»ƒåŸºæœ¬ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>âš™ï¸ è¶…å‚æ•°</h6>
                                            <div id="hyperparamsInfo">
                                                <!-- è¶…å‚æ•°ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <h6>ğŸ“ˆ è®­ç»ƒè¿‡ç¨‹æŒ‡æ ‡</h6>
                                            <div class="data-table-container" style="max-height: 400px;">
                                                <table class="table table-striped table-hover table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>è½®æ¬¡</th>
                                                            <th>è®­ç»ƒæŸå¤±</th>
                                                            <th>è®­ç»ƒMAE</th>
                                                            <th>è®­ç»ƒMSE</th>
                                                            <th>è®­ç»ƒMAPE</th>
                                                            <th>æµ‹è¯•æŸå¤±</th>
                                                            <th>æµ‹è¯•MAE</th>
                                                            <th>æµ‹è¯•MSE</th>
                                                            <th>æµ‹è¯•MAPE</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="metricsTableBody">
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';

        // çœä»½åˆ—è¡¨å¸¸é‡
        const PROVINCES = [
            "åŒ—äº¬å¸‚", "å¤©æ´¥å¸‚", "ä¸Šæµ·å¸‚", "é‡åº†å¸‚", "å†…è’™å¤è‡ªæ²»åŒº", "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº",
            "è¥¿è—è‡ªæ²»åŒº", "å®å¤å›æ—è‡ªæ²»åŒº", "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº", "æ²³åŒ—çœ", "å±±è¥¿çœ",
            "è¾½å®çœ", "å‰æ—çœ", "é»‘é¾™æ±Ÿçœ", "æ±Ÿè‹çœ", "æµ™æ±Ÿçœ", "å®‰å¾½çœ", "ç¦å»ºçœ",
            "æ±Ÿè¥¿çœ", "å±±ä¸œçœ", "æ²³å—çœ", "æ¹–åŒ—çœ", "æ¹–å—çœ", "å¹¿ä¸œçœ", "æµ·å—çœ",
            "å››å·çœ", "è´µå·çœ", "äº‘å—çœ", "é™•è¥¿çœ", "ç”˜è‚ƒçœ", "é’æµ·çœ"
        ];

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'primary') {
            alert(`[${type.toUpperCase()}] ${message}`);
        }

        // ===================================
        // 1. æ¦‚è§ˆ & åŸºç¡€æ•°æ®åŠŸèƒ½
        // ===================================
        
        async function fetchTables() {
            try {
                const response = await fetch(`${API_BASE}/tables`);
                const data = await response.json();

                if (data.code === 0 && data.data) {
                    const tableListBody = document.getElementById('tableListBody');
                    tableListBody.innerHTML = '';
                    document.getElementById('tableCount').textContent = data.data.length;

                    data.data.forEach(table => {
                        const row = tableListBody.insertRow();
                        row.insertCell().textContent = table.name;
                        row.insertCell().textContent = table.api_base_path;
                        row.insertCell().textContent = table.unit;
                        const actionCell = row.insertCell();
                        const btn = document.createElement('button');
                        btn.className = 'btn btn-sm btn-outline-primary';
                        btn.textContent = 'æŸ¥çœ‹æ•°æ®';
                        btn.onclick = () => fetchTableData(table.name, table.unit);
                        actionCell.appendChild(btn);
                    });
                } else {
                    document.getElementById('tableListBody').innerHTML = '<tr><td colspan="4" class="text-center">åŠ è½½è¡¨ä¿¡æ¯å¤±è´¥</td></tr>';
                }
            } catch (error) {
                console.error('Fetch tables error:', error);
                document.getElementById('tableListBody').innerHTML = `<tr><td colspan="4" class="text-center">ç½‘ç»œé”™è¯¯: ${error.message}</td></tr>`;
            }
        }

        async function fetchTableData(tableName, unit) {
            try {
                const response = await fetch(`${API_BASE}/${tableName}?page=1&size=50`);
                const data = await response.json();

                const modalLabel = document.getElementById('dataModalLabel');
                const modalUnit = document.getElementById('dataModalUnit');
                const modalTotal = document.getElementById('dataModalTotal');
                const detailTable = document.getElementById('dataDetailTable');

                modalLabel.textContent = `${tableName} - å‰50æ¡è®°å½•`;
                modalUnit.textContent = unit || 'æ— ';
                modalTotal.textContent = data.total || 'N/A';
                detailTable.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼

                if (data.code === 0 && data.data.length > 0) {
                    const columns = Object.keys(data.data[0]);
                    
                    const thead = detailTable.createTHead();
                    const headerRow = thead.insertRow();
                    columns.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = col;
                        headerRow.appendChild(th);
                    });

                    const tbody = detailTable.createTBody();
                    data.data.forEach(rowObj => {
                        const row = tbody.insertRow();
                        columns.forEach(col => {
                            row.insertCell().textContent = rowObj[col];
                        });
                    });
                } else {
                    detailTable.innerHTML = '<tr><td>æ— æ•°æ®æˆ–åŠ è½½å¤±è´¥</td></tr>';
                }

                new bootstrap.Modal(document.getElementById('dataModal')).show();

            } catch (error) {
                console.error(`Fetch ${tableName} data error:`, error);
                showNotification(`åŠ è½½ ${tableName} æ•°æ®å¤±è´¥`, 'danger');
            }
        }


        // ===================================
        // 2. è€¦åˆåè°ƒåº¦åˆ†æåŠŸèƒ½
        // ===================================

        async function setupCouplingAnalysis() {
            try {
                const yearsResponse = await fetch(`${API_BASE}/years`);
                const yearsData = await yearsResponse.json();
                const select = document.getElementById('couplingYearSelect');
                select.innerHTML = '';
                
                if (yearsData.success && yearsData.years) {
                    yearsData.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                    if (yearsData.years.length > 0) {
                        select.value = yearsData.years[yearsData.years.length - 1];
                    }
                } else {
                    select.innerHTML = '<option value="">åŠ è½½å¹´ä»½å¤±è´¥</option>';
                }
            } catch (error) {
                console.error('Setup coupling analysis error:', error);
            }

            document.getElementById('loadCouplingDataBtn').onclick = loadCouplingData;
            document.getElementById('loadCouplingTrendBtn').onclick = loadCouplingTrendData;
        }
        async function loadCouplingData() {
            const year = document.getElementById('couplingYearSelect').value;
            if (!year) return showNotification('è¯·é€‰æ‹©å¹´ä»½', 'warning');

            document.getElementById('couplingStatsYear').textContent = year;
            document.getElementById('couplingStats').textContent = 'åŠ è½½ä¸­...';
            document.getElementById('couplingRegionsBody').innerHTML = '<tr><td colspan="9" class="text-center">åŠ è½½ä¸­...</td></tr>';
            
            try {
                // åŠ è½½ç»Ÿè®¡ä¿¡æ¯å’Œåœ°åŒºåˆ—è¡¨
                const regionsResponse = await fetch(`${API_BASE}/regions?year=${year}`);
                const regionsData = await regionsResponse.json();

                const dataResponse = await fetch(`${API_BASE}/data?year=${year}`);
                const dataData = await dataResponse.json();

                // å¡«å……ç»Ÿè®¡ä¿¡æ¯
                if (dataData.success) {
                    document.getElementById('couplingStats').textContent = JSON.stringify(dataData.statistics, null, 2);
                    showNotification(`${year}å¹´è€¦åˆåè°ƒåº¦ç»Ÿè®¡ä¿¡æ¯åŠ è½½æˆåŠŸ`, 'success');
                } else {
                    document.getElementById('couplingStats').textContent = dataData.message || 'åŠ è½½å¤±è´¥';
                }

                // å¡«å……åœ°åŒºæ’å
                const regionsBody = document.getElementById('couplingRegionsBody');
                regionsBody.innerHTML = '';
                if (regionsData.success && regionsData.regions) {
                    regionsData.regions.forEach((region, index) => {
                        const row = regionsBody.insertRow();
                        row.insertCell().textContent = index + 1;
                        row.insertCell().textContent = region.name;
                        row.insertCell().textContent = region.coordination_degree.toFixed(4);
                        row.insertCell().textContent = region.coordination_level;
                        row.insertCell().textContent = region.development_type;
                        row.insertCell().textContent = region.coupling_degree.toFixed(4);
                        row.insertCell().textContent = region.U_p.toFixed(4);
                        row.insertCell().textContent = region.U_e.toFixed(4);
                    });
                } else {
                    regionsBody.innerHTML = `<tr><td colspan="9" class="text-center">${regionsData.message || 'åœ°åŒºåˆ—è¡¨åŠ è½½å¤±è´¥'}</td></tr>`;
                }

            } catch (error) {
                console.error('Load coupling data error:', error);
                showNotification('åŠ è½½è€¦åˆåè°ƒåº¦æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'danger');
            }
        }
        async function loadCouplingTrendData() {
            document.getElementById('couplingTrendData').textContent = 'åŠ è½½å…¨éƒ¨è¶‹åŠ¿æ•°æ®ä¸­ï¼Œè¯·ç¨å€™...';
            try {
                const response = await fetch(`${API_BASE}/all_trend`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('couplingTrendData').textContent = JSON.stringify(data, (key, value) => {
                        // æˆªæ–­é•¿æ•°ç»„ï¼Œé˜²æ­¢é¡µé¢å¡é¡¿
                        if (key === 'trend_data' && Array.isArray(value)) {
                            return `[Array: ${value.length} records. Displaying first 5 only] ${JSON.stringify(value.slice(0, 5))}`;
                        }
                        return value;
                    }, 2);
                    showNotification(`æˆåŠŸåŠ è½½ ${data.total_records} æ¡è¶‹åŠ¿æ•°æ®`, 'success');
                } else {
                    document.getElementById('couplingTrendData').textContent = data.message || 'åŠ è½½å¤±è´¥';
                }
            } catch (error) {
                console.error('Load trend data error:', error);
                showNotification('åŠ è½½è¶‹åŠ¿æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'danger');
                document.getElementById('couplingTrendData').textContent = `é”™è¯¯: ${error.message}`;
            }
        }
        // ===================================
        // 3. GDPç©ºé—´åˆ†æåŠŸèƒ½
        // ===================================

        async function loadSpatialAvailableYears() {
            try {
                const response = await fetch(`${API_BASE}/spatial/available-years`);
                const data = await response.json();
                const select = document.getElementById('spatialYearSelect');
                select.innerHTML = '';

                if (data.status === 'success' && data.available_years.length > 0) {
                    data.available_years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                    select.value = data.available_years[data.available_years.length - 1];
                    showNotification(`æˆåŠŸåŠ è½½ ${data.total_count} ä¸ªå·²åˆ†æå¹´ä»½`, 'success');
                } else {
                    select.innerHTML = '<option value="">æš‚æ— å·²åˆ†æå¹´ä»½ (è¯·åˆ·æ–°æ•°æ®)</option>';
                    showNotification(data.message || 'åŠ è½½å¯ç”¨å¹´ä»½å¤±è´¥', 'warning');
                }
            } catch (error) {
                console.error('Load spatial years error:', error);
                showNotification('åŠ è½½ç©ºé—´åˆ†æå¯ç”¨å¹´ä»½æ—¶å‘ç”Ÿé”™è¯¯', 'danger');
            }
        }

        async function refreshSpatialData() {
            if (!confirm('ç¡®å®šè¦è§¦å‘ç©ºé—´åˆ†ææ•°æ®åˆ·æ–°å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿã€‚')) return;
            
            showNotification('æ­£åœ¨è§¦å‘ç©ºé—´åˆ†ææ•°æ®åˆ·æ–°...è¯·ç­‰å¾…ã€‚', 'info');
            try {
                const response = await fetch(`${API_BASE}/spatial/refresh`, { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('ç©ºé—´åˆ†ææ•°æ®åˆ·æ–°æˆåŠŸ! è¯·ç‚¹å‡» "åŠ è½½å¯ç”¨å¹´ä»½" æŸ¥çœ‹ç»“æœã€‚', 'success');
                    loadSpatialAvailableYears(); // åˆ·æ–°å¹´ä»½åˆ—è¡¨
                } else {
                    showNotification(`æ•°æ®åˆ·æ–°å¤±è´¥: ${data.message}`, 'danger');
                }
            } catch (error) {
                console.error('Refresh spatial data error:', error);
                showNotification('åˆ·æ–°ç©ºé—´åˆ†ææ•°æ®æ—¶å‘ç”Ÿç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯', 'danger');
            }
        }

        async function loadSpatialStats() {
            const year = document.getElementById('spatialYearSelect').value;
            if (!year) return showNotification('è¯·é€‰æ‹©å·²åˆ†æå¹´ä»½', 'warning');

            document.getElementById('spatialStatsYear').textContent = year;
            document.getElementById('spatialStats').textContent = 'åŠ è½½ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/spatial/stats/${year}`);
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('spatialStats').textContent = JSON.stringify(data, null, 2);
                    showNotification(`${year}å¹´ç©ºé—´ç»Ÿè®¡ä¿¡æ¯åŠ è½½æˆåŠŸ`, 'success');
                } else {
                    document.getElementById('spatialStats').textContent = data.error;
                    showNotification(`åŠ è½½ ${year} å¹´ç»Ÿè®¡ä¿¡æ¯å¤±è´¥`, 'warning');
                }
            } catch (error) {
                console.error('Load spatial stats error:', error);
                showNotification('åŠ è½½ç©ºé—´ç»Ÿè®¡ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯', 'danger');
            }
        }

        async function loadSpatialGeoJson() {
            const year = document.getElementById('spatialYearSelect').value;
            if (!year) return showNotification('è¯·é€‰æ‹©å·²åˆ†æå¹´ä»½', 'warning');

            document.getElementById('spatialGeoJson').textContent = 'åŠ è½½ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/spatial/data/${year}`);
                const data = await response.json();

                // GeoJSONæ•°æ®é‡å¯èƒ½å¾ˆå¤§ï¼Œä»…æ˜¾ç¤ºå‰å‡ è¡Œ
                if (data.type === 'FeatureCollection') {
                    const truncatedFeatures = data.features.slice(0, 2);
                    const previewData = {
                        type: data.type,
                        features_count: data.features.length,
                        preview_features: truncatedFeatures,
                        // ç§»é™¤geometryå±æ€§ï¼Œé˜²æ­¢æ‰“å°è¿‡é•¿
                        message: `GeoJSONæ•°æ®åŠ è½½æˆåŠŸ, å…± ${data.features.length} ä¸ªç‰¹å¾ (ä»…æ˜¾ç¤ºå‰2ä¸ªçš„å±æ€§)`
                    };
                    document.getElementById('spatialGeoJson').textContent = JSON.stringify(previewData, (key, value) => {
                        // åœ¨é¢„è§ˆä¸­ç§»é™¤geometryä»¥ä¿æŒç®€æ´
                        return key === 'geometry' ? '[... Omitted Geometry Data ...]' : value;
                    }, 2);
                    showNotification(`${year}å¹´ GeoJSON æ•°æ®é¢„è§ˆæˆåŠŸ`, 'success');
                } else {
                    document.getElementById('spatialGeoJson').textContent = JSON.stringify(data, null, 2);
                    showNotification(`åŠ è½½ ${year} å¹´ GeoJSON æ•°æ®å¤±è´¥`, 'warning');
                }
            } catch (error) {
                console.error('Load spatial geojson error:', error);
                showNotification('åŠ è½½ç©ºé—´ GeoJSON æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'danger');
            }
        }


        // ===================================
        // 4. GDP é¢„æµ‹åŠŸèƒ½ (æ›´æ–°ä¸ºåˆ—è¡¨)
        // ===================================

        function setupPredictUI() {
            const provinceSelect = document.getElementById('predictProvinceSelect');
            provinceSelect.innerHTML = '';
            PROVINCES.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
            document.getElementById('fetchAndDisplayChartBtn').onclick = executePrediction;
            document.getElementById('loadDbPredictionsBtn').onclick = loadDatabasePredictions;
            document.getElementById('loadDbMetricsBtn').onclick = loadDatabaseMetrics;
            document.getElementById('exportDatabaseBtn').onclick = exportDatabase;
        }

        async function executePrediction() {
            const province = document.getElementById('predictProvinceSelect').value;
            if (!province) {
                showNotification('è¯·é€‰æ‹©ä¸€ä¸ªçœä»½', 'warning');
                return;
            }

            const resultArea = document.getElementById('predictionResultArea');
            const resultBody = document.getElementById('predictionResultBody');
            const metricsArea = document.getElementById('metricsResultArea');
            
            resultArea.style.display = 'block';
            metricsArea.style.display = 'block';
            resultBody.innerHTML = '<tr><td colspan="3" class="text-center">åŠ è½½ä¸­...</td></tr>';
            
            showNotification(`æ­£åœ¨ä¸º ${province} è·å–å†å²ã€é¢„æµ‹æ•°æ®å’Œè®­ç»ƒæŒ‡æ ‡...`, 'info');

            try {
                const [historicalRes, predictionRes, metricsRes] = await Promise.all([
                    fetch(`${API_BASE}/gdp/historical/${province}`),
                    fetch(`${API_BASE}/gdp/predict/${province}`),
                    fetch(`${API_BASE}/gdp/metrics/${province}`)
                ]);

                const historicalPayload = await historicalRes.json();
                const predictionPayload = await predictionRes.json();
                const metricsPayload = await metricsRes.json();

                if (!historicalPayload.success) throw new Error(`è·å–å†å²æ•°æ®å¤±è´¥: ${historicalPayload.message}`);
                if (!predictionPayload.success) throw new Error(`è·å–é¢„æµ‹æ•°æ®å¤±è´¥: ${predictionPayload.message}`);
                
                resultBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼

                // å¡«å……å†å²æ•°æ®
                historicalPayload.data.forEach(item => {
                    const row = resultBody.insertRow();
                    row.innerHTML = `
                        <td>${item.year}</td>
                        <td>${item.gdp.toFixed(2)}</td>
                        <td><span class="badge bg-secondary">å†å²æ•°æ®</span></td>
                    `;
                });

                // å¡«å……é¢„æµ‹æ•°æ®
                predictionPayload.data.forEach(item => {
                    const row = resultBody.insertRow();
                    row.classList.add('table-primary'); // é«˜äº®é¢„æµ‹è¡Œ
                    row.innerHTML = `
                        <td><strong>${item.year}</strong></td>
                        <td class="fw-bold">${item.gdp.toFixed(2)}</td>
                        <td><span class="badge bg-primary">é¢„æµ‹æ•°æ®</span></td>
                    `;
                });

                // æ˜¾ç¤ºè®­ç»ƒæŒ‡æ ‡
                displayTrainingMetrics(metricsPayload, province);

                resultArea.scrollIntoView({ behavior: 'smooth' });
                showNotification(`${province} çš„GDPæ•°æ®å’Œè®­ç»ƒæŒ‡æ ‡å·²æ›´æ–°`, 'success');

            } catch (error) {
                console.error('Prediction execution error:', error);
                showNotification(`æ‰§è¡Œé¢„æµ‹æ—¶å‡ºé”™: ${error.message}`, 'danger');
                resultBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">é”™è¯¯: ${error.message}</td></tr>`;
            }
        }

        function displayTrainingMetrics(metricsPayload, province) {
            const trainingInfo = document.getElementById('trainingInfo');
            const hyperparamsInfo = document.getElementById('hyperparamsInfo');
            const metricsTableBody = document.getElementById('metricsTableBody');

            if (!metricsPayload.success) {
                trainingInfo.innerHTML = `<div class="alert alert-warning">âš ï¸ æœªæ‰¾åˆ° ${province} çš„è®­ç»ƒæŒ‡æ ‡æ•°æ®</div>`;
                hyperparamsInfo.innerHTML = '';
                metricsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-warning">æ— è®­ç»ƒæŒ‡æ ‡æ•°æ®</td></tr>';
                return;
            }

            const metrics = metricsPayload.metrics;
            
            // æ˜¾ç¤ºè®­ç»ƒåŸºæœ¬ä¿¡æ¯
            trainingInfo.innerHTML = `
                <div class="small">
                    <strong>çœä»½:</strong> ${metrics.province}<br>
                    <strong>è®­ç»ƒæ—¶é—´:</strong> ${new Date(metrics.saved_at).toLocaleString()}<br>
                    <strong>è®­ç»ƒè½®æ¬¡:</strong> ${metrics.num_epochs}
                </div>
            `;

            // æ˜¾ç¤ºè¶…å‚æ•°
            const hp = metrics.hyperparams;
            hyperparamsInfo.innerHTML = `
                <div class="small">
                    <strong>è¾“å…¥ç‰¹å¾æ•°:</strong> ${hp.input_feature_size}<br>
                    <strong>éšè—å±‚å¤§å°:</strong> ${hp.hidden_size}<br>
                    <strong>LSTMå±‚æ•°:</strong> ${hp.num_layers}<br>
                    <strong>é¢„æµ‹æ­¥æ•°:</strong> ${hp.predict_steps}<br>
                    <strong>çª—å£å¤§å°:</strong> ${hp.window_size}<br>
                    <strong>æ‰¹æ¬¡å¤§å°:</strong> ${hp.batch_size}
                </div>
            `;

            // æ˜¾ç¤ºè®­ç»ƒè¿‡ç¨‹æŒ‡æ ‡
            metricsTableBody.innerHTML = '';
            const metricsData = metrics.metrics;
            const numEpochs = metricsData.train_loss.length;
            
            for (let i = 0; i < numEpochs; i++) {
                const row = metricsTableBody.insertRow();
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${metricsData.train_loss[i].toFixed(4)}</td>
                    <td>${metricsData.train_mae[i].toFixed(4)}</td>
                    <td>${metricsData.train_mse[i].toFixed(4)}</td>
                    <td>${metricsData.train_mape[i].toFixed(4)}</td>
                    <td>${metricsData.test_loss[i].toFixed(4)}</td>
                    <td>${metricsData.test_mae[i].toFixed(4)}</td>
                    <td>${metricsData.test_mse[i].toFixed(4)}</td>
                    <td>${metricsData.test_mape[i].toFixed(4)}</td>
                `;
                
                // é«˜äº®æœ€åå‡ è½®ï¼ˆæ”¶æ•›æƒ…å†µï¼‰
                if (i >= numEpochs - 5) {
                    row.classList.add('table-success');
                }
            }
        }

        // ===================================
        // 5. é¡µé¢åˆå§‹åŒ–
        // ===================================

        document.addEventListener('DOMContentLoaded', () => {
            fetchTables();
            setupCouplingAnalysis();
            document.getElementById('refreshSpatialDataBtn').onclick = refreshSpatialData;
            document.getElementById('loadSpatialYearsBtn').onclick = loadSpatialAvailableYears;
            document.getElementById('loadSpatialStatsBtn').onclick = loadSpatialStats;
            document.getElementById('loadSpatialGeoJsonBtn').onclick = loadSpatialGeoJson;
            loadSpatialAvailableYears();
            setupPredictUI();
        });
    </script>
</body>
</html>